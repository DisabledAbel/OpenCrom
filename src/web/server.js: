// src/web/server.js
import express from "express";
import cors from "cors";
import session from "express-session";
import fetch from "node-fetch";
import cronParser from "cron-parser";

const app = express();
const PORT = process.env.PORT || 3000;

// ---------- Middleware ----------
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(
  session({
    secret: process.env.SESSION_SECRET || "super-secret-key",
    resave: false,
    saveUninitialized: true,
    cookie: { secure: false, maxAge: 1000 * 60 * 60 }, // 1 hour
  })
);

// ---------- Routes ----------
app.get("/", (req, res) => {
  res.send("âœ… Server is running on Render!");
});

app.get("/fetch-example", async (req, res) => {
  try {
    const response = await fetch("https://api.github.com");
    const data = await response.json();
    res.json({ success: true, data });
  } catch (err) {
    res.status(500).json({ success: false, error: err.message });
  }
});

// Example session route
app.get("/session", (req, res) => {
  if (!req.session.views) req.session.views = 0;
  req.session.views++;
  res.json({ views: req.session.views });
});

// ---------- Cron Parser Example ----------
app.get("/next-cron", (req, res) => {
  try {
    const interval = cronParser.parseExpression("*/5 * * * *"); // every 5 minutes
    const next = interval.next().toString();
    res.json({ nextRun: next });
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
});

// ---------- Start Server ----------
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on port ${PORT}`);
});
